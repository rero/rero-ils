{%- extends config.RECORDS_UI_BASE_TEMPLATE %}
{% set data = record.dumps() %}
{% from 'rero_ils/macros/macro.html' import div_row, div_json %}

{%- block page_body %}
<div class="container search-page">
  <div class="row">
    <div class="col-xs-2" id="thumbnail">
      <icon-thumbnail class="thumb"
        {% if record.identifiers %}
          identifiers='{{ (record.identifiers or {})|tojson }}'
        {% else %}
          identifiers=""
        {% endif %}
        type="{{ record.type }}"
        config='{{ {"thumbnail_service_url": config.RERO_ILS_THUMBNAIL_SERVICE_URL} | tojson }}'>
      </icon-thumbnail>
    </div>
    <div class="col-xs-10">
      <h1>{{ data.title }}</h1>
    </div>
  </div>
  {%- block record_body %}

  <!-- AUTHORS -->
  {% if data.authors|length > 0 %}
    {{ div_row(_('Author'), data.authors|authors_format) }}
  {% endif %}

  <!-- PUBLISHERS -->
  {% if data.publishers|length > 0 %}
  {{ div_row(_('Publisher'), data.publishers|publishers_format) }}
  {% endif %}

  <!-- PUBLICATION YEAR -->
  {% if data.publicationYear %}
  {{ div_row(
    _('Date'),
    data.freeFormedPublicationDate if data.freeFormedPublicationDate else data.publicationYear
  ) }}
  {% endif %}

  <!-- ABSTRACT -->
  {% if data.abstracts|length > 0 %}
    {{ div_row(_('Abstract'), data.abstracts|abstracts_format|nl2br) }}
  {% endif %}

  <!-- PHYSICAL DESCRIPTION -->
  {% if data.extent or data.otherMaterialCharacteristics or data.formats %}
    {% set formats = ', '.join(data.formats) %}
    {% set description = ', '.join([data.extent, data.otherMaterialCharacteristics, formats]|select) %}
    {{ div_row(_('Physical description'), description) }}
  {% endif %}

  <!-- ADDITIONAL MATERIALS -->
  {% if data.additionalMaterials %}
    {{ div_row(_('Additional Materials'), data.additionalMaterials) }}
  {% endif %}

  <!-- SERIES -->
  {% if data.series|length > 0 %}
    {{ div_row(_('Series'), data.series|series_format) }}
  {% endif %}

  <!-- UNIFORM TITLE -->
  {% if data.titlesProper|length > 0 %}
    {{ div_row(_('Uniform title'), data.titlesProper|join('; ')) }}
  {% endif %}

  <!-- IS PART OF -->
  {% if data.is_part_of %}
    {{ div_row(_('Is part of'), data.is_part_of) }}
  {% endif %}

  <!-- SUBJECTS -->
  {% if data.subjects|length > 0 %}
    {{ div_row(_('Subjects'), data.subjects|join('; ')) }}
  {% endif %}

  <!-- NOTES -->
  {% if data.notes|length > 0 %}
  {{ div_row(_('Notes'), notes|abstracts_format|nl2br) }}
  {% endif %}

  {% if data.identifiers %}
    {% if data.identifiers.isbn %}
      {{ div_row(_('ISBN'), data.identifiers.isbn) }}
    {% endif %}
  {% endif %}

  {% if data.electronic_location|length > 0 %}
    {% set uris = [] %}
    {% for resource in data.electronic_location %}
      {% do uris.append('<a href="'+ resource.uri +'"><i class="fa fa-lock fa-fw"></i> '+ resource.uri +'</a>') %}
    {% endfor %}
    {{ div_row(_('Online Access'), uris|join(', ')) }}
  {% endif %}

  {% if data.source %}
    {{ div_row(
      _('Source'),
      '<a href="'+ data.source +'" target="_blank">'+ data.source +'</a>'
    ) }}
  {% endif %}

  <div class="row">
    <div class="col-xs-2 col-xs-offset-2">
        {{ _('Permalink') }}:
    </div>
    <div class="col-xs-8">
      {{ url_for('invenio_records_ui.doc', pid_value=data.pid, _external=True) }}
    </div>
  </div>
  {% if record.can_edit %}
    {% with
      href_update=url_for('doc.edit_view', pid=data.pid),
      href_delete=url_for('doc.delete_view', pid=data.pid),
      json=record,
      message=_("Document cannot be deleted: there are still items linked to this document.")
    %}
      {% include 'rero_ils/_editor_button_actions.html' %}
    {% endwith %}
  {% else %}
    {%- if current_user|can_edit %}
      {{ div_json(_('JSON'), data) }}
    {% endif %}
  {% endif %}
  <hr/>

  <!-- Items -->
  {% if record.can_edit %}
    {%- if current_user|can_edit or data.itemslist %}
    <div class='reroils-items row'>
      <div class="col-sm-12">
        <h3>{{ _('Items') }}
          {%- if current_user|can_edit %}
          <a href="{{ url_for('item.create_view',
          parent_pid=data.pid) }}" type="button" class="btn btn-sm btn-success">
            <i class="fa fa-pencil-square-o fa-fw"></i> {{ _('Add') }}
          </a>
          {% endif %}
        </h3>
      </div>
    </div>
    {% endif %}

    {% if record.itemslist %}
      {% for item in record.itemslist %}
      {% set item_dump = item.dumps() %}

      {% if item.barcode %}
        {{ div_row(
          _('Barcode'),
          '<a href="'+ url_for('invenio_records_ui.item', pid_value=item.pid) +'">'+item.barcode+'</a>' if current_user|can_edit else item.barcode
        ) }}
      {% endif %}

      {% if item.call_number %}
        {{ div_row(_('Call Number'), item.call_number) }}
      {% endif %}

      {% if item_dump.library_name %}
        {{ div_row(
          _('Library'),
          '<a href="'+ url_for('invenio_records_ui.lib', pid_value=item_dump.library_pid) +'">'+item_dump.library_name+'</a>'
        ) }}
      {% endif %}

      {% if item_dump.location_name %}
        {{ div_row(
          _('Location'),
          '<a href="'+ url_for('invenio_records_ui.loc', pid_value=item.location_pid) +'">'+item_dump.location_name+'</a>')
        }}
      {% endif %}

      {% if item|number_of_requests > 0 %}
        {% if item|requested_this_item %}
          {{ div_row(_('Rank'), item|patron_request_rank) }}
        {% endif %}
      {% endif %}

      {% if item.status %}
        {{ div_row(
          _('Status'),
          '<i class="fa fa-circle text-'+ ('success' if item.available else 'danger') +'"></i> '+
          item|item_status_text(format='short_date', locale=current_i18n.locale.language)
        ) }}
      {% endif %}

      <div class="row">
        <div class="col-sm-2">
          {% if item|can_request %}
            <button type="button" class="btn btn-primary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            {{ _('Request') }} <i class="fa fa-caret-down fa-fw"></i>
            </button>

            <ul class="dropdown-menu">
              <li><a>{{ _('Available Pickup Locations') }}</a></li>
              <li role="separator" class="divider"></li>
              {% set locations = item.pid|item_library_pickup_locations %}

              {% for location in locations %}
                <li>
                  <a href="{{ url_for('items.request_item', item_pid_value=item.pid, location=location.pid)}}">
                    {{ location.name }}
                  </a>
                </li>
              {% endfor %}
            </ul>
          {% endif %}
        </div>
        <div class="col-sm-9">
          {% with
            href_update=url_for('item.edit_view', pid=item.pid),
            href_delete=url_for('item.delete_view', pid=item.pid),
            json=item,
            message=_("Item cannot be deleted: there are still transactions linked to this item.")
          %}
            {% include 'rero_ils/_editor_button_actions.html' %}
          {% endwith %}
        </div>
      </div>
      <hr/>
      {% endfor %}
    {% endif %}
  {% endif %}

  {%- set formats = export_formats(pid.pid_type) %}
  {%- if formats %}
    <div class="row">
      <div class="col-sm-11">
        <h3>{{ _('Export Formats') }}</h3>
      </div>
      <div class="col-sm-11">
        <ul class="list-inline">
        {%- for slug, fmt in formats %}
          <li>
            <a href="{{ url_for('invenio_records_ui.doc_export', pid_value=pid.pid_value, format=slug, prettyprint=True) }}">{{ fmt.title }}</a>
          </li>
        {%- endfor %}
        </ul>
      </div>
    </div>
  {%- endif %}
  {%- endblock %}
</div>
{%- endblock %}

{%- block javascript %}
{{ super() }}
{% assets "rero_ils_documents_detailed_js" %}<script src="{{ ASSET_URL }}"></script>{% endassets %}
{%- endblock javascript %}